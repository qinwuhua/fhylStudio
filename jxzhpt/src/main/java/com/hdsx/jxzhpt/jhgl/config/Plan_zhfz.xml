<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "/xsd/mybatis-3-mapper.dtd">
<mapper namespace="com.hdsx.jxzhpt.plan_zhfz">
	<resultMap type="plan_zhfz"  id="zhfz_jh">
		<id property="id" column="id" />
		<result property="sbnf" column="sbnf"/>
		<result property="sbzt" column="sbzt"/>
		<result property="spzt" column="spzt"/>
		<result property="jh_sbthcd" column="jh_sbthcd"/>
		<result property="pfztz" column="pfztz"/>
		<result property="jhkgsj" column="jhkgsj"/>
		<result property="jhwgsj" column="jhwgsj"/>
		<result property="jgzt" column="jgzt"/>
		<result property="kgzt" column="kgzt"/>
		<result property="jhsybzje" column="jhsybzje"/>
		<result property="jhsydfzcje" column="jhsydfzcje"/>
		<result property="sfylsjl" column="sfylsjl"/>
		<result property="ylxbm" column="ylxbm"/>
        <result property="yqdzh" column="yqdzh"/>
        <result property="yzdzh" column="yzdzh"/>
        <result property="ylxmc" column="ylxmc"/>
		<association property="jckzhfz"  column="SCK_ZHFZ_ID"  resultMap="zhfz_lx"></association>
	</resultMap>
	<resultMap type="sckzhfz"  id="zhfz_lx">
		<id property="id" column="id" />
		<result property="gydw" column="gydw"/>
		<result property="bzls" column="bzls"/>
		<result property="xzqhmc" column="xzqhmc"/>
		<result property="lxbm" column="lxbm"/>
		<result property="lxmc" column="lxmc"/>
		<result property="qdzh" column="qdzh"/>
		<result property="zdzh" column="zdzh"/>
		<result property="qzlc" column="qzlc"/>
		<result property="yhlc" column="yhlc"/>
	</resultMap>
	<select id="queryZhfzList"  parameterType="java.util.Map"  resultMap="zhfz_jh">
		select * from 
			(
				select rownum as num,t.* from (
					select jh.jh_sbthcd,jh.sbzt,jh.spzt,jh.kgzt,jh.jgzt,jh.jhkgsj,jh.jhwgsj,jh.sbnf,jh.id,jh.sckid,jh.pfztz,sc.bzls as sfylsjl,
					lx.lxmc,lx.lxbm,lx.gydw,lx.gydwbm,lx.qdzh,lx.zdzh,lx.yhlc,lx.xzqhmc,lx.xzqhdm,lx.ylxbm,lx.yqdzh,lx.yzdzh,lx.ylxmc
					from plan_zhfz jh left join sck_zhfz sc on (jh.sckid=sc.sckid)
					left join xmk_zhfz lx on (sc.xmkid=lx.id) where 1=1
				 	<if test="jh.jh_sbthcd!=null and jh.jh_sbthcd!='' and (jh.sbzt==null or jh.sbzt=='') and (jh.spzt==null or jh.spzt=='')">
						and jh.jh_sbthcd=#{jh.jh_sbthcd}
					</if>
					<if test="(jh.sbzt!=null or jh.spzt!=null) and (jh.sbzt!='' or jh.spzt!='') and jh.jh_sbthcd!=null and jh.jh_sbthcd!=''">
						and (jh.jh_sbthcd=#{jh.jh_sbthcd} or jh.jh_sbthcd=#{jh.jh_sbthcd}+2)
					</if>
				 	<if test="jh.sbnf!=null and jh.sbnf!=''">
	 					${jh.sbnf}
	 				</if>
	 				<if test="jh.sbzt!=null and jh.sbzt!=''">
	 					and jh.sbzt=#{jh.sbzt}
	 				</if>
	 				<if test="jh.spzt!=null and jh.spzt!=''">
	 					and jh.spzt=#{jh.spzt}
	 				</if>
	 				<if test="jh.kgzt!=null and jh.kgzt!=''">
			 			and jh.kgzt=#{jh.kgzt}
			 		</if>
			 		<if test="jh.jgzt!=null and jh.jgzt!=''">
			 			and jh.jgzt=#{jh.jgzt}
			 		</if>
			 		<if test="jh.sfylsjl!=null and jh.sfylsjl!=''">
			 			and sc.bzls=#{jh.sfylsjl}
				 	</if>
	 				<if test="lx.gydwbm!=null and lx.gydwbm!=''">
	 					and ${lx.gydwbm}
	 				</if>
	 				<if test="lx.xzqhdm!=null and lx.xzqhdm!=''">
	 					and ${lx.xzqhdm}
	 				</if>
	 				<if test="lx.lxmc!=null and lx.lxmc!=''">
	 					and lx.lxmc like '%'||#{lx.lxmc}||'%'
	 				</if>
	 				<if test="lx.gldj!=null and lx.gldj!=''">
	 					${lx.gldj}
	 				</if>
	 				<if test="lx.lxbm !=null and lx.lxbm !=''">
	 					${lx.lxbm}
	 				</if>
	 				<if test="lx.lxjsdj!=null and lx.lxjsdj!=''">
	 					and lx.lxjsdj like '%'|| #{lx.lxjsdj}||'%'
	 				</if>
	 				<if test="lx.tsdq!=null and lx.tsdq!=''">
				 		and lx.xzqhdm in (select t.xzqhdm from xtgl_xzqhtsdq t where t.parent =#{lx.tsdq})
				 	</if>
				 	<if test="lx.xmklx != null and lx.xmklx != ''">
	 					and lx.xmklx like '%'||#{lx.xmklx}||'%'
	 				</if>
				 	order by jh.sbnf desc,jh.jh_sbthcd
			 	) t order by t.sbnf desc,t.jh_sbthcd
			)
 			where <![CDATA[ num <= (#{page} * #{rows})]]> and num>(#{page}-1)*#{rows}
	</select>
	<select id="queryZhfzList2"  parameterType="java.util.Map"  resultMap="zhfz_jh">
		select * from 
			(
				select rownum as num,t.* from (
					select * from plan_zhfz jh left join sck_zhfz sc on (jh.sckid=sc.sckid)
					left join xmk_zhfz lx on (sc.xmkid=lx.id) where 1=1
				 	<if test="jh.jh_sbthcd!=null and jh.jh_sbthcd!=''">
						and jh.jh_sbthcd=#{jh.jh_sbthcd}
					</if>
				 	<if test="jh.sbnf!=null and jh.sbnf!=''">
	 					and jh.sbnf=#{jh.sbnf}
	 				</if>
	 				<if test="jh.kgzt!=null and jh.kgzt!=''">
			 			and jh.kgzt=#{jh.kgzt}
			 		</if>
			 		<if test="jh.jgzt!=null and jh.jgzt!=''">
			 			and jh.jgzt=#{jh.jgzt}
			 		</if>
			 		<if test="jh.sfylsjl!=null and jh.sfylsjl!=''">
			 			and sc.bzls=#{jh.sfylsjl}
				 	</if>
	 				<if test="lx.gydwbm!=null and lx.gydwbm!=''">
	 					and ${lx.gydwbm}
	 				</if>
	 				<if test="lx.xzqhdm!=null and lx.xzqhdm!=''">
	 					and ${lx.xzqhdm}
	 				</if>
	 				<if test="lx.lxmc!=null and lx.lxmc!=''">
	 					and lx.lxmc like '%'||#{lx.lxmc}||'%'
	 				</if>
	 				<if test="lx.gldj!=null and lx.gldj!=''">
	 					${lx.gldj}
	 				</if>
	 				<if test="lx.lxjsdj!=null and lx.lxjsdj!=''">
	 					and lx.lxjsdj = #{lx.lxjsdj}
	 				</if>
	 				<if test="lx.tsdq!=null and lx.tsdq!=''">
				 		and lx.xzqhdm in (select t.xzqhdm from xtgl_xzqhtsdq t where t.parent =#{lx.tsdq})
				 	</if>
				 	<if test="lx.xmklx != null and lx.xmklx != ''">
	 					and lx.xmklx like '%'||#{lx.xmklx}||'%'
	 				</if>
	 				<if test="lx.lxbm !=null and lx.lxbm !=''">
	 					${lx.lxbm}
	 				</if>
				 	order by jh.jh_sbthcd,jh.sbnf
			 	) t
			)
	</select>
	<select id="queryZhfzByStatus" parameterType="java.util.Map" resultType="plan_zhfz">
		select * from plan_zhfz jh left join sck_zhfz sc on (jh.sckid=sc.sckid)
		left join xmk_zhfz lx on (sc.xmkid=lx.id) where 1=1
		<if test="jh.jh_sbthcd!=null and jh.jh_sbthcd!='' and (jh.sbzt==null or jh.sbzt=='') and (jh.spzt==null or jh.spzt=='')">
			and jh.jh_sbthcd=#{jh.jh_sbthcd}
		</if>
		<if test="(jh.sbzt!=null or jh.spzt!=null) and (jh.sbzt!='' or jh.spzt!='') and jh.jh_sbthcd!=null and jh.jh_sbthcd!=''">
			and (jh.jh_sbthcd=#{jh.jh_sbthcd} or jh.jh_sbthcd=#{jh.jh_sbthcd}+2)
		</if>
	 	<if test="jh.sbzt!=null and jh.sbzt!=''">
	 		and jh.sbzt=#{jh.sbzt}
	 	</if>
	 	<if test="jh.spzt!=null and jh.spzt!=''">
	 		and jh.spzt=#{jh.spzt}
	 	</if>
	 	<if test="lx.gydwbm!=null and lx.gydwbm!=''">
	 		and ${lx.gydwbm}
	 	</if>
	</select>
	<select id="queryZhfzCount"  parameterType="java.util.Map"  resultType="int">
		select count(*) from plan_zhfz jh left join sck_zhfz sc on (jh.sckid=sc.sckid) 
		left join xmk_zhfz lx on (sc.xmkid=lx.id) where 1=1
		<if test="jh.jh_sbthcd!=null and jh.jh_sbthcd!='' and (jh.sbzt==null or jh.sbzt=='') and (jh.spzt==null or jh.spzt=='')">
						and jh.jh_sbthcd=#{jh.jh_sbthcd}
					</if>
					<if test="(jh.sbzt!=null or jh.spzt!=null) and (jh.sbzt!='' or jh.spzt!='') and jh.jh_sbthcd!=null and jh.jh_sbthcd!=''">
						and (jh.jh_sbthcd=#{jh.jh_sbthcd} or jh.jh_sbthcd=#{jh.jh_sbthcd}+2)
					</if>
				 	<if test="jh.sbnf!=null and jh.sbnf!=''">
	 					${jh.sbnf}
	 				</if>
	 				<if test="jh.sbzt!=null and jh.sbzt!=''">
	 					and jh.sbzt=#{jh.sbzt}
	 				</if>
	 				<if test="jh.spzt!=null and jh.spzt!=''">
	 					and jh.spzt=#{jh.spzt}
	 				</if>
	 				<if test="jh.kgzt!=null and jh.kgzt!=''">
			 			and jh.kgzt=#{jh.kgzt}
			 		</if>
			 		<if test="jh.jgzt!=null and jh.jgzt!=''">
			 			and jh.jgzt=#{jh.jgzt}
			 		</if>
			 		<if test="jh.sfylsjl!=null and jh.sfylsjl!=''">
			 			and sc.bzls=#{jh.sfylsjl}
				 	</if>
	 				<if test="lx.gydwbm!=null and lx.gydwbm!=''">
	 					and ${lx.gydwbm}
	 				</if>
	 				<if test="lx.xzqhdm!=null and lx.xzqhdm!=''">
	 					and ${lx.xzqhdm}
	 				</if>
	 				<if test="lx.lxmc!=null and lx.lxmc!=''">
	 					and lx.lxmc like '%'||#{lx.lxmc}||'%'
	 				</if>
	 				<if test="lx.gldj!=null and lx.gldj!=''">
	 					${lx.gldj}
	 				</if>
	 				<if test="lx.xmklx != null and lx.xmklx != ''">
	 					and lx.xmklx like '%'||#{lx.xmklx}||'%'
	 				</if>
	 				<if test="lx.lxbm !=null and lx.lxbm !=''">
	 					${lx.lxbm}
	 				</if>
	 				<if test="lx.lxjsdj!=null and lx.lxjsdj!=''">
	 					and lx.lxjsdj like '%'|| #{lx.lxjsdj}||'%'
	 				</if>
	 				<if test="lx.tsdq!=null and lx.tsdq!=''">
				 		and lx.xzqhdm in (select t.xzqhdm from xtgl_xzqhtsdq t where t.parent =#{lx.tsdq})
				 	</if>
	</select>
	<select id="queryZhfzNfs"  resultType="treenode">
		select distinct t.sbnf as text from PLAN_zhfz t order by t.sbnf
	</select>
	<select id="insertToSheet" parameterType="hashMap" resultType="sjbb">
			select xzqhdm      v_0,
		       xzqhmc      v_1,
		       sc.sck_lxbm v_2,
		       sc.sck_lxmc v_3,
		       sc.scqdzh   v_4,
		       sc.sczdzh   v_5,
		       sc.scyhlc   v_6,
		       sc.jsxz     v_7,
		       sc.jsnr     v_8,
		       jh.sbnf v_9,
		       to_char(jh.jhkgsj, 'yyyy-mm-dd') v_10,
		       to_char(jh.jhwgsj, 'yyyy-mm-dd') v_11,
		       to_char(jh.xdsj, 'yyyy-mm-dd') v_12,
		       jh.sjdw v_13,
		       jh.sjpfdw v_14,
		       jh.pfwh v_15,
		       to_char(jh.pfsj, 'yyyy-mm-dd') v_16,
		       jh.pfztz v_17,
		       jh.jhsybzje v_18,
		       jh.jhsydfzcje v_19,
		       jh.sfsqablbz v_20,
		       jh.ablbzsqwh v_21,
		       jh.bz v_22
		  from sck_zhfz sc, xmk_zhfz xm,plan_zhfz jh
		 where sc.xmkid = xm.id and jh.sckid = sc.sckid 
		   and sck_sbzt = '已上报'
		   and sc.lrjh = '已列入'
		    and jh.spzt='0'
		 and sck_sbthcd &lt;=#{sck_sbthcd}  
		 <if test="tbdw!=null and tbdw!=''">
		 	and scbmbm like #{tbdw}||'%'
		 </if>
	</select>
	<select id="exportExcel_jh" parameterType="hashMap" resultType="elist">
		select rownum v_0,(select name from xtgl_xzqh where id=substr(lx.xzqhdm,0,4)||'00') v_1,lx.xzqhmc v_2,
        '' v_3,'' v_4,'' v_5,'' v_6,lx.lxbm v_7,lx.lxmc v_8, 
        to_char(jh.jhqdzh,'fm9999999990.000') v_9,to_char(jh.jhzdzh,'fm9999999990.000') v_10,
        to_char(sc.sczlc,'fm9999999990.000') v_11,to_char(sc.scyhlc,'fm9999999990.000') v_12,
       nvl(jh.pfztz,0) v_13,nvl(jh.jhsybzje,0) v_14,nvl(jh.jhsydfzcje,0) v_15,sc.jsxz v_16,
       sc.jsnr v_17,jh.pfwh v_18,jh.sbnf v_19,
       lx.gydw v_20,jh.sbnf v_21,jh.bz v_22,t.tsdq v_23
    from plan_zhfz jh
    left join sck_zhfz sc on (jh.sckid = sc.sckid)
    left join xmk_zhfz lx on (sc.xmkid = lx.id) 
    left join (select  replace(WMSYS.WM_CONCAT(distinct(to_char(t.name))),',',',') tsdq,x.xzqhdm 
                from xtgl_xzqhtsdq x left join xtgl_tsdq t on x.parent=t.id  group by x.xzqhdm) t 
               on lx.xzqhdm=t.xzqhdm
    where 1=1
		<if test="jh.jh_sbthcd!=null and jh.jh_sbthcd!='' and (jh.sbzt==null or jh.sbzt=='') and (jh.spzt==null or jh.spzt=='')">
						and jh.jh_sbthcd=#{jh.jh_sbthcd}
					</if>
					<if test="(jh.sbzt!=null or jh.spzt!=null) and (jh.sbzt!='' or jh.spzt!='') and jh.jh_sbthcd!=null and jh.jh_sbthcd!=''">
						and (jh.jh_sbthcd=#{jh.jh_sbthcd} or jh.jh_sbthcd=#{jh.jh_sbthcd}+2)
					</if>
	 	<if test="jh.sbnf!=null and jh.sbnf!=''">
				${jh.sbnf}
			</if>
			<if test="jh.sbzt!=null and jh.sbzt!=''">
				and jh.sbzt=#{jh.sbzt}
			</if>
			<if test="jh.spzt!=null and jh.spzt!=''">
				and jh.spzt=#{jh.spzt}
			</if>
			<if test="lx.gydwdm!=null and lx.gydwdm!=''">
				and ${lx.gydwdm}
			</if>
			<if test="lx.xzqhdm!=null and lx.xzqhdm!=''">
				and ${lx.xzqhdm}
			</if>
			<if test="lx.lxmc!=null and lx.lxmc!=''">
				and lx.lxmc like '%'||#{lx.lxmc}||'%'
			</if>
            <if test="jh.sfylsjl!=null and jh.sfylsjl!=''">
			 	and sc.bzls=#{jh.sfylsjl}
			</if>
			<if test="lx.lxjsdj!=null and lx.lxjsdj!=''">
				and lx.lxjsdj like '%'|| #{lx.lxjsdj}||'%'
			</if>
			<if test="lx.lxbm !=null and lx.lxbm !=''">
	 					${lx.lxbm}
	 		</if>
	 		<if test="lx.tsdq!=null and lx.tsdq!=''">
				 and lx.xzqhdm in (select t.xzqhdm from xtgl_xzqhtsdq t where t.parent =#{lx.tsdq})
			</if>
			<if test="lx.xmklx != null and lx.xmklx != ''">
	 			and lx.xmklx like '%'||#{lx.xmklx}||'%'
	 		</if>
	</select>
	<select id="queryZhfzById" parameterType="string" resultType="plan_zhfz">
		select  id,sckid,sbnf,jhkgsj,jhwgsj, sjdw,sjpfdw,pfwh, pfsj,pfztz, jhsybzje, jhsydfzcje, sfsqablbz,ablbzsqwh, bz,tbsj,
   tbbm,spzt,spbm,spsj,sbzt, sbbm, sbsj, xdsj,gkbgmc,gkbglj,sjsgtmc,sjsgtlj,sjkgsj,sjwgsj,sgdw,jldw,htje,sgxkwj,
  jgtcwj,jgyswj,wjsczt,kgzt,jgzt,wjgyy,yjwgsj, jsdw, jhxdwh, xdzt, xfzt,xfsj,xfbm,wjzt,wjsj,gys, sbbmdm,spbmdm,sfylsjl
  from plan_zhfz jh where jh.id=#{id}
	</select>
	<delete id="dropZhfzById" parameterType="string">
		delete from plan_zhfz jh where jh.id=#{id}
	</delete>
	<update id="editZhfzById" parameterType="plan_zhfz">
		update plan_zhfz set sbnf=#{sbnf}
			<if test="jhkgsj!=null and jhkgsj!=''">,jhkgsj=#{jhkgsj}</if>
			<if test="jhwgsj!=null and jhwgsj!=''">,jhwgsj=#{jhwgsj}</if>
			<if test="xdsj!=null and xdsj!=''">,xdsj=#{xdsj}</if>
			<if test="pfsj!=null and pfsj!=''">,pfsj=#{pfsj}</if>
			<if test="jhxdwh!=null">,jhxdwh=#{jhxdwh}</if>
			<if test="sjdw!=null">,sjdw=#{sjdw}</if>
			<if test="sjpfdw!=null">,sjpfdw=#{sjpfdw}</if>
			<if test="pfwh!=null">,pfwh=#{pfwh}</if>
			<if test="pfztz!=null">,pfztz=#{pfztz}</if>
			<if test="jhsybzje!=null">,jhsybzje=#{jhsybzje}</if>
			<if test="jhsydfzcje!=null">,jhsydfzcje=#{jhsydfzcje}</if>
			<if test="sfsqablbz!=null">,sfsqablbz=#{sfsqablbz}</if>
			<if test="ablbzsqwh!=null">,ablbzsqwh=#{ablbzsqwh}</if>
			<if test="bz!=null">,bz=#{bz}</if>
		where id=#{id}
	</update>
	<update id="editZhfzSckBysckid" parameterType="sckzhfz">
		update SCK_ZHFZ set sckid=#{sckid}
		<if test="scqdzh!=null">,scqdzh=#{scqdzh}</if>
		<if test="sczdzh!=null">,sczdzh=#{sczdzh}</if>
		<if test="sczlc!=null">,sczlc=#{sczlc}</if>
		<if test="scyhlc!=null">,scyhlc=#{scyhlc}</if>
		<if test="fapgdw!=null">,fapgdw=#{fapgdw}</if>
		<if test="fascdw!=null">,fascdw=#{fascdw}</if>
		<if test="faspsj!=null">,faspsj=#{faspsj}</if>
		<if test="spwh!=null">,spwh=#{spwh}</if>
		<if test="tzgs!=null">,tzgs=#{tzgs}</if>
		<if test="jsxz!=null">,jsxz=#{jsxz}</if>
		<if test="jsnr!=null">,jsnr=#{jsnr}</if>
		<if test="scbz!=null">,scbz=#{scbz}</if>
		where sckid=#{sckid}
	</update>
	<update id="editZhfzStatus" parameterType="plan_zhfz">
		update plan_zhfz set 
			<if test="sbbm!=null and sbbm!=''">sbbm=#{sbbm},</if>
			<if test="sbbmdm!=null and sbbmdm!=''">sbbmdm=#{sbbmdm},</if>
			<if test="sbsj!=null and sbsj!=''">sbsj=#{sbsj},</if>
			<if test="sbzt!=null and sbzt!=''">sbzt=#{sbzt},</if>
			<if test="spbm!=null and spbm!=''">spbm=#{spbm},</if>
			<if test="spbmdm!=null and spbmdm!=''">spbmdm=#{spbmdm},</if>
			<if test="spsj!=null and spsj!=''">spsj=#{spsj},</if>
			<if test="spzt!=null and spzt!=''">spzt=#{spzt},</if>
			jh_sbthcd=#{jh_sbthcd}
		where id=#{id}
	</update>
	<!-- <insert id="importZhfz_jh" parameterType="hashMap">
		insert into PLAN_ZHFZ(id,sckid,sbnf,jhkgsj,jhwgsj,xdsj,sjdw, sjpfdw,pfwh,pfsj,pfztz,jhsybzje,jhsydfzcje,sfsqablbz,ablbzsqwh,bz,xdzt)
		values(sys_guid(),(select id from xmk_zhfz where lxbm=#{2} and lxmc=#{3} and qdzh=#{4} and zdzh=#{5}),#{9},to_date(#{10},'yyyy-mm-dd'),to_date(#{11},'yyyy-mm-dd'),to_date(#{12},'yyyy-mm-dd'),#{13},#{14},#{15},to_date(#{16},'yyyy-mm-dd'),#{17},#{18},#{19},#{20},#{21},#{22},'0')
	</insert> -->
	
	<update id="importZhfz_jh" parameterType="hashMap">
		update PLAN_ZHFZ set sbnf=#{9},jhkgsj=to_date(#{10},'yyyy-mm-dd'),jhwgsj=to_date(#{11},'yyyy-mm-dd'),xdsj=to_date(#{12},'yyyy-mm-dd'),sjdw=#{13},sjpfdw=#{14},pfwh=#{15},pfsj=to_date(#{16},'yyyy-mm-dd'),pfztz=#{17},jhsybzje=#{18},jhsydfzcje=#{19},sfsqablbz=#{20},ablbzsqwh=#{21},bz=#{22}
		where sckid = (select sckid from sck_zhfz where sck_lxbm=#{2} and sck_lxmc=#{3} and scqdzh=#{4} and sczdzh=#{5})
	</update>
	<select id="querySumZhfz" resultMap="zhfz_jh" parameterType="java.util.Map">
		select count(id) as id,sum(qzlc) as qzlc,sum(yhlc) as yhlc,
		sum(pfztz) as pfztz,sum(jhsybzje) as jhsybzje,sum(jhsydfzcje) as jhsydfzcje,sum(bz) spzt from(
			select count(jh.id) as id,sum(sc.sczlc) as qzlc,sum(sc.scyhlc) as yhlc,
			sum(jh.pfztz) as pfztz,sum(jh.jhsybzje) as jhsybzje,sum(jh.jhsydfzcje) as jhsydfzcje,decode(sum(xdzj),null,0,sum(xdzj)) bz 
			from xmk_zhfz lx right join sck_zhfz sc on (lx.id=sc.xmkid) right join plan_zhfz jh on (sc.sckid=jh.sckid) left join plan_zjxd zj on jh.id=zj.xmid
			where 1=1
			<if test="jh.jh_sbthcd!=null and jh.jh_sbthcd!='' and (jh.sbzt==null or jh.sbzt=='') and (jh.spzt==null or jh.spzt=='')">
						and jh.jh_sbthcd=#{jh.jh_sbthcd}
					</if>
					<if test="(jh.sbzt!=null or jh.spzt!=null) and (jh.sbzt!='' or jh.spzt!='') and jh.jh_sbthcd!=null and jh.jh_sbthcd!=''">
						and (jh.jh_sbthcd=#{jh.jh_sbthcd} or jh.jh_sbthcd=#{jh.jh_sbthcd}+2)
					</if>
				 	<if test="jh.sbnf!=null and jh.sbnf!=''">
	 					${jh.sbnf}
	 				</if>
	 				<if test="jh.sbzt!=null and jh.sbzt!=''">
	 					and jh.sbzt=#{jh.sbzt}
	 				</if>
	 				<if test="jh.spzt!=null and jh.spzt!=''">
	 					and jh.spzt=#{jh.spzt}
	 				</if>
	 				<if test="jh.kgzt!=null and jh.kgzt!=''">
			 			and jh.kgzt=#{jh.kgzt}
			 		</if>
			 		<if test="jh.jgzt!=null and jh.jgzt!=''">
			 			and jh.jgzt=#{jh.jgzt}
			 		</if>
			 		<if test="jh.sfylsjl!=null and jh.sfylsjl!=''">
			 			and sc.bzls=#{jh.sfylsjl}
				 	</if>
	 				<if test="lx.gydwbm!=null and lx.gydwbm!=''">
	 					and ${lx.gydwbm}
	 				</if>
	 				<if test="lx.xzqhdm!=null and lx.xzqhdm!=''">
	 					and ${lx.xzqhdm}
	 				</if>
	 				<if test="lx.lxmc!=null and lx.lxmc!=''">
	 					and lx.lxmc like '%'||#{lx.lxmc}||'%'
	 				</if>
	 				<if test="lx.gldj!=null and lx.gldj!=''">
	 					${lx.gldj}
	 				</if>
	 				<if test="lx.lxjsdj!=null and lx.lxjsdj!=''">
	 					and lx.lxjsdj like '%'|| #{lx.lxjsdj}||'%'
	 				</if>
	 				<if test="lx.xmklx != null and lx.xmklx != ''">
	 					and lx.xmklx like '%'||#{lx.xmklx}||'%'
	 				</if>
	 				<if test="lx.lxbm !=null and lx.lxbm !=''">
	 					${lx.lxbm}
	 				</if>
	 				<if test="lx.tsdq!=null and lx.tsdq!=''">
				 		and lx.xzqhdm in (select t.xzqhdm from xtgl_xzqhtsdq t where t.parent =#{lx.tsdq})
				 	</if>
	 				group by jh.id)
	</select>
	<update id="updateLrztBySckid" parameterType="java.util.List">
 		update sck_zhfz set lrjh='未列入'  where sckid= (select z.sckid from plan_zhfz z where z.id=#{id})
 	</update>
 	<insert id="insertZhFile" parameterType="plan_upload">
 		insert into plan_upload(filename,filedata,parentid,filetype) 
		values(#{filename},#{filedata},#{parentid},#{filetype})
 	</insert>
 	<select id="queryZhfzFjById"  parameterType="string"  resultType="plan_zhfz">
		select  gkbgmc,gkbgdata,sjsgtmc,sjsgtdata from Plan_Zhfz jh where jh.id=#{id}
	</select>
	<select id="queryJcktj" resultType="treenode">
	select substr(xm.xzqhdm,0,length(${id})) as id,count(xm.xzqhdm),sum(xm.yhlc) 
	from plan_zhfz jh left join sck_zhfz sc on (jh.sckid=sc.sckid) left join xmk_zhfz xm on 
	(sc.xmkid=xm.id) left join  xtgl_xzqh xt on (xm.xzqhdm=xt.id)
	where xm.xzqhdm like ${id}||'%' group by substr(xm.xzqhdm,0,length(${id}))
		<!-- select t1.*,xz.name from (
			select t.parent as id,count(t.parent)-1 as text,NVL(sum(t.yhlc),0) as parent
			 from (
			       select distinct xt.parent,jck.xzqhdm,jck.yhlc 
			       from xmk_zhfz jck right join xtgl_xzqh xt on (jck.xzqhdm=xt.id) 
			       order by xt.parent
			) t where t.parent is not null group by t.parent
		) t1 join xtgl_xzqh xz on (t1.id=xz.id)  order by t1.id -->
	</select>
	<select id="queryJcktj1" resultType="treenode" parameterType="java.util.Map">
		select t.parent as id,xz.name as name,NVL(sum(t.je),0) as text,sum(t.sl) as parent from (
			select distinct xt.parent,jh.sbnf,
      		(select ab1.jhsybzje from plan_zhfz ab1 left join sck_zhfz sc1 on 
      		(ab1.sckid=sc1.sckid) left join xmk_zhfz lx1 on (sc1.xmkid=lx1.id) where ab1.sbnf=#{nf} and ab1.id=jh.id) as je,
      		(select count(jhsybzje) from plan_zhfz ab1 left join sck_zhfz sc1 on 
			(ab1.sckid=sc1.sckid) left join xmk_zhfz lx1 on (sc1.xmkid=lx1.id) where ab1.sbnf=#{nf} and ab1.id=jh.id) as sl
			from plan_zhfz jh left join sck_zhfz sc on 
			(jh.sckid=sc.sckid) left join xmk_zhfz lx on (sc.xmkid=lx.id) right join xtgl_xzqh xt on (lx.xzqhdm=xt.id)
			where xt.parent is not null
		) t join xtgl_xzqh xz on (t.parent=xz.id)
		group by t.parent,xz.name order by t.parent
	</select>
	<select id="queryJhktj2" resultType="treenode" parameterType="java.util.Map">
		select t.sbnf as id,sum(t.jhsybzje) as text,count(t.jhsybzje) as name from (
		select distinct jh.id,jh.sbnf,jh.jhsybzje from 
		plan_zhfz jh left join sck_zhfz sc on (jh.sckid=sc.sckid) 
		left join xmk_zhfz lx on (sc.xmkid=lx.id) 
		where lx.xzqhdm like rtrim(#{xzqhdm},'0')||'%' and jh.sbnf>=#{start} and <![CDATA[jh.sbnf<=#{end}]]>) t
		group by t.sbnf
	</select>
	<select id="queryJhktjt2" resultType="treenode" parameterType="java.util.Map">
		select NVL(sum(t.jhsybzje),0) from (
		select distinct jh.id,jh.sbnf,jh.jhsybzje from 
		plan_zhfz jh left join sck_zhfz sc on (jh.sckid=sc.sckid) 
		left join xmk_zhfz lx on (sc.xmkid=lx.id) 
		where lx.xzqhdm like #{xzqhdm} and jh.sbnf=#{nf}) t group by t.sbnf
	</select>
	<select id="queryJhktjt3" resultType="treenode" parameterType="java.util.Map">
		select sbnf as name,sum(jhsybzje) as text from (
			select distinct jh.id,jh.sbnf,jh.jhsybzje from plan_zhfz jh left join sck_zhfz sc on (jh.sckid=sc.sckid) 
			left join xmk_zhfz lx on (sc.xmkid=lx.id) 
			where lx.xzqhdm like #{xzqhdm} and jh.sbnf>=#{start} and <![CDATA[jh.sbnf<=#{end}]]>) 
			group by sbnf
	</select>
	<select id="queryGcktj" resultType="treenode" parameterType="java.util.Map">
		select (r.kgzt+r.jgzt) as id,count(r.kgzt+r.jgzt) as name,sum(r.jhsybzje) as text,sum(r.btz+r.qttz) as parent from (
			select jh_lx.id,jh_lx.kgzt,jh_lx.jgzt,jh_lx.jhsybzje,sum(nvl(gcgl.wc_btz,0)) as btz,sum(nvl(gcgl.wc_qttz,0)) as qttz from gcgl_zhfz gcgl 
				right join (select jh.id,jh.kgzt,jh.jgzt,jh.jhsybzje from  plan_zhfz jh left join sck_zhfz sc on (jh.sckid=sc.sckid) 
		    	left join xmk_zhfz lx on (sc.xmkid=lx.id) where lx.xzqhdm like #{xzqhdm} and jh.sbnf=#{nf} and jh.spzt='1' and jh.jh_sbthcd='6') jh_lx on gcgl.jhid=jh_lx.id
	    group by jh_lx.id,jh_lx.kgzt,jh_lx.jgzt,jh_lx.jhsybzje) r group by r.kgzt,r.jgzt order by r.kgzt,r.jgzt
	</select>
	<select id="queryGcktjt" resultType="treenode" parameterType="java.util.Map">
		select nvl(sum(r.jhsybzje),0) as text,nvl(sum(r.btz+r.qttz),0) as parent from (
			select jh_lx.id,jh_lx.kgzt,jh_lx.jgzt,jh_lx.jhsybzje,sum(nvl(gcgl.wc_btz,0)) as btz,sum(nvl(gcgl.wc_qttz,0)) as qttz from gcgl_zhfz gcgl 
				right join (select jh.id,jh.kgzt,jh.jgzt,jh.jhsybzje from  plan_zhfz jh left join sck_zhfz sc on (jh.sckid=sc.sckid) 
		    	left join xmk_zhfz lx on (sc.xmkid=lx.id) where jh.spzt='1' and jh.jh_sbthcd='6'
		    	<if test="xzqhdm!=null and xzqhdm!=''">
		    		and lx.xzqhdm like #{xzqhdm}
		    	</if>
		    	) jh_lx on gcgl.jhid=jh_lx.id
	    group by jh_lx.id,jh_lx.kgzt,jh_lx.jgzt,jh_lx.jhsybzje) r
	</select>
	<select id="queryGcktj2" resultType="treenode" parameterType="java.util.Map">
		select nvl(sum(r.bn),0) as id,count(r.bn) as name,nvl(sum(r.fbn),0) as text,count(r.fbn) as parent from (
			select jh.id,jh.kgzt,jh.jgzt,
				(select a.jhsybzje from plan_zhfz a where a.sbnf=#{nf} and a.id=jh.id) as bn,
				(select a.jhsybzje from plan_zhfz a where #{nf}>a.sbnf and a.id=jh.id) as fbn 
			from plan_zhfz jh left join sck_zhfz sc on (jh.sckid=sc.sckid) 
			left join xmk_zhfz lx on (sc.xmkid=lx.id) 
			where jh.spzt='1' and jh.jh_sbthcd='6'
		and lx.xzqhdm like #{xzqhdm}) r
	</select>
	<update id="editZjById" parameterType="plan_zhfz">
		update plan_zhfz jh set jh.pfztz=#{pfztz},jh.jhsybzje=#{jhsybzje},jh.jhsydfzcje=#{jhsydfzcje}
		where jh.id=#{id}
	</update>
	<select id="exportExcelZhfzJhSh" parameterType="java.util.Map" resultType="plan_zhfz">
		select * from 
			(
				select rownum as num,t.* from (
					select lx.xzqhmc,lx.gydw,lx.lxbm,lx.lxmc,sc.scqdzh,sc.sczdzh,sc.sczlc,sc.scyhlc,sc.fapgdw,sc.fascdw,sc.faspsj,sc.spwh,
					sc.tzgs,sc.jsxz,sc.jsnr,sc.scbz,jh.sbnf,to_char(jh.jhkgsj,'yyyy-mm-dd'),to_char(jh.jhwgsj,'yyyy-mm-dd'),jh.sjdw,jh.sjpfdw,jh.pfsj,jh.pfwh,
					jh.sfsqablbz,jh.ablbzsqwh,jh.pfztz,jh.jhsybzje,jh.jhsydfzcje,jh.bz,jh.id,jh.sckid
					from plan_zhfz jh left join sck_zhfz sc on (jh.sckid=sc.sckid)
					left join xmk_zhfz lx on (sc.xmkid=lx.id) where 1=1
				 	<if test="jh.jh_sbthcd!=null and jh.jh_sbthcd!='' and (jh.sbzt==null or jh.sbzt=='') and (jh.spzt==null or jh.spzt=='')">
						and jh.jh_sbthcd=#{jh.jh_sbthcd}
					</if>
					<if test="(jh.sbzt!=null or jh.spzt!=null) and (jh.sbzt!='' or jh.spzt!='') and jh.jh_sbthcd!=null and jh.jh_sbthcd!=''">
						and (jh.jh_sbthcd=#{jh.jh_sbthcd} or jh.jh_sbthcd=#{jh.jh_sbthcd}+2)
					</if>
				 	<if test="jh.sbnf!=null and jh.sbnf!=''">
	 					and jh.sbnf=#{jh.sbnf}
	 				</if>
	 				<if test="jh.sbzt!=null and jh.sbzt!=''">
	 					and jh.sbzt=#{jh.sbzt}
	 				</if>
	 				<if test="jh.spzt!=null and jh.spzt!=''">
	 					and jh.spzt=#{jh.spzt}
	 				</if>
	 				<if test="jh.kgzt!=null and jh.kgzt!=''">
			 			and jh.kgzt=#{jh.kgzt}
			 		</if>
			 		<if test="jh.jgzt!=null and jh.jgzt!=''">
			 			and jh.jgzt=#{jh.jgzt}
			 		</if>
			 		<if test="jh.sfylsjl!=null and jh.sfylsjl!=''">
			 			and sc.bzls=#{jh.sfylsjl}
				 	</if>
	 				<if test="lx.gydwbm!=null and lx.gydwbm!=''">
	 					and ${lx.gydwbm}
	 				</if>
	 				<if test="lx.xzqhdm!=null and lx.xzqhdm!=''">
	 					and ${lx.xzqhdm}
	 				</if>
	 				<if test="lx.lxmc!=null and lx.lxmc!=''">
	 					and lx.lxmc like '%'||#{lx.lxmc}||'%'
	 				</if>
	 				<if test="lx.lxbm!=null and lx.lxbm!=''">
	 					and lx.lxbm like #{lx.lxbm}||'%'
	 				</if>
	 				<if test="lx.lxjsdj!=null and lx.lxjsdj!=''">
	 					and lx.lxjsdj = #{lx.lxjsdj}
	 				</if>
	 				<if test="lx.tsdq!=null and lx.tsdq!=''">
				 		and lx.xzqhdm in (select t.xzqhdm from xtgl_xzqhtsdq t where t.parent =#{lx.tsdq})
				 	</if>
				 	order by jh.sbnf desc,jh.jh_sbthcd
			 	) t order by t.sbnf desc
			)
	</select>
	<update id="updateimportExcelZhfzJh" parameterType="plan_zhfz">
		update plan_zhfz set
		<if test="sbnf!=null">sbnf=#{sbnf},</if>
		<if test="jhkgsj1!=null">jhkgsj=to_date(#{jhkgsj1},'yyyy-mm-dd'),</if>
		<if test="jhwgsj1!=null">jhwgsj=to_date(#{jhwgsj1},'yyyy-mm-dd'),</if>
		<if test="sjdw!=null">sjdw=#{sjdw},</if>
		<if test="sjpfdw!=null">sjpfdw=#{sjpfdw},</if>
		<if test="pfwh!=null">pfwh=#{pfwh},</if>
		<if test="pfsj1!=null">pfsj=to_date(#{pfsj1},'yyyy-mm-dd'),</if>
		<if test="sfsqablbz!=null">sfsqablbz=#{sfsqablbz},</if>
		<if test="ablbzsqwh!=null">ablbzsqwh=#{ablbzsqwh},</if>
		<if test="pfztz!=null">pfztz=#{pfztz},</if>
		<if test="jhsybzje!=null">jhsybzje=#{jhsybzje},</if>
		<if test="jhsydfzcje!=null">jhsydfzcje=#{jhsydfzcje},</if>
		<if test="bz!=null">bz=#{bz},</if>
		id=#{id}
		where id=#{id}
	</update>
	<update id="updateimportExcelZhfzSh" parameterType="plan_zhfz">
		update sck_zhfz set
		<if test="scqdzh!=null">scqdzh=#{scqdzh},</if>
		<if test="sczdzh!=null">sczdzh=#{sczdzh},</if>
		<if test="sczlc!=null">sczlc=#{sczlc},</if>
		<if test="scyhlc!=null">scyhlc=#{scyhlc},</if>
		<if test="fapgdw!=null">fapgdw=#{fapgdw},</if>
		<if test="fascdw!=null">fascdw=#{fascdw},</if>
		<if test="faspsj!=null">faspsj=#{faspsj},</if>
		<if test="spwh!=null">spwh=#{spwh},</if>
		<if test="tzgs!=null">tzgs=#{tzgs},</if>
		<if test="jsxz!=null">jsxz=#{jsxz},</if>
		<if test="jsnr!=null">jsnr=#{jsnr},</if>
		<if test="scbz!=null">scbz=#{scbz},</if>
		sckid=#{sckid}
		where sckid=#{sckid}
	</update>
</mapper>
