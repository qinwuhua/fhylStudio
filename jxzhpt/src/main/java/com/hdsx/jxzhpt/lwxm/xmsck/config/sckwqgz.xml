<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "/xsd/mybatis-3-mapper.dtd">
<mapper namespace="com.hdsx.jxzhpt.sckwqgz">
	<insert id="insertSckwqgz" parameterType="sckwqgz">
		insert into
		sck_wqgz(sckid,xmkid,tzgs,spwh,fapgdw,fascdw,faspsj,jsxz,jsnr,scbz,scbmbm,sck_sbzt,sck_shzt,sck_qlbh,sck_qlzxzh,
		sck_lxbm,sck_sbthcd,lrjh,bzls,scxmnf,scqlqc,scqlqk)
		values(sys_guid(),#{xmkid},#{tzgs},#{spwh},#{fapgdw},#{fascdw},#{faspsj},#{jsxz},#{jsnr},#{scbz},
		#{scbmbm},'未上报','未审核',#{qlbh},#{qlzxzh},#{lxbm},#{sck_sbthcd},'未列入',#{bzls},#{scxmnf},#{scqlqc},#{scqlqk})
	</insert>
	
	<insert id="lrjhSckwqgz"  parameterType="java.util.List">
		insert into plan_wqgz(id,sckid,xdzt,sbnf,jh_sbthcd,jhsybzje,shengbz,sfylrbwqk,sfkxg,sfylsjl,qlszxz,zyjsnr,jhjsxz,pfsj,sjdw,sjpfdw,pfwh,jhqlqc,jhqlqk,pfztz)
		select 
		sys_guid(),sc.sckid,'未下达',sc.scxmnf,'2',sc.nsqbbz,sc.nsqsbz,'是','是',sc.bzls,sc.scszxz,sc.jsnr,sc.jsxz,sc.faspsj,sc.fapgdw,sc.fascdw,sc.spwh,sc.scqlqc,sc.scqlqk,sc.ztz
		from sck_wqgz sc
		where sc.sckid=#{sckid}
	</insert>
 	<insert id="xglrjhSckwqgz"  parameterType="java.util.List">
		update sck_wqgz set lrjh='已列入'  where sckid=#{String}
	</insert>

	<select id="selectSckwqgz" parameterType="sckwqgz" resultType="sckwqgz">
		select * from (
		select rownum num ,t.*,decode(sck_sbthcd,#{sck_sbthcd},'未上报',sck_sbzt) sck_sbzt2 from
		 (select * from sck_wqgz t join xmk_wqgz on xmkid=xmk_wqgz.id where 1=1 and t.SFYLRBWQK='是'
 				<if test="tsdq!='' and tsdq!= null ">
 				${tsdq}
 				</if><if test="xmklx !='' and xmklx != null ">
 			and xmklx like '%'||(#{xmklx})||'%'
 		</if>
 				) t where 
			sck_sbthcd &lt;=#{sck_sbthcd}
		<if test="gydw!='' and gydw!= null ">
			${gydw}
		</if>
		<if test="xzqhdm!='' and xzqhdm!= null ">
			${xzqhdm}
		</if>
		<if test="lxmc!='' and lxmc!= null ">
			and lxmc like '%'||(#{lxmc})||'%'
		</if>
		<if test="qlmc!='' and qlmc!= null ">
			and qlmc like '%'||(#{qlmc})||'%'
		</if>
		<if test="xmnf!='' and xmnf!= null ">
			and scxmnf in (${xmnf})
		</if>
		<if test="xmtype!='' and xmtype!= null ">
			and xmtype like '%'||(#{xmtype})||'%'
		</if>
		<if test="sbzt!='' and sbzt!= null ">
			and decode(sck_sbthcd,#{sck_sbthcd},'未上报',sck_sbzt) like '%'||(#{sbzt})||'%'
		</if>
		 <if test="jsdj!='' and jsdj!= null ">
			${jsdj}
		</if> 
		 <if test="gldj!='' and gldj!= null ">
			${gldj}
		</if> 
		<if test="akjfl!='' and akjfl!= null ">
			${akjfl}
		</if>
		<if test="bzls!='' and bzls!= null ">
 			and bzls like #{bzls}||'%'
 		</if>
 		<if test="lxbm!='' and lxbm!= null ">
			and lxbm like '%'||(#{lxbm})||'%'
		</if>
		<if test="qlbh!='' and qlbh!= null ">
			and qlbh like '%'||(#{qlbh})||'%'
		</if>
		) t1 where t1.num &lt;=(#{page} * #{rows}) and
		t1.num>(#{page}-1)*#{rows}
		order by decode(sck_sbthcd,#{sck_sbthcd},'未上报',sck_sbzt),sck_shzt desc
	</select>
	<select id="selectWqgzCount" parameterType="sckwqgz" resultType="int">
		select count(*) from (select * from sck_wqgz t join xmk_wqgz on xmkid=xmk_wqgz.id where 1=1 and t.SFYLRBWQK='是'
 				<if test="tsdq!='' and tsdq!= null ">
 				${tsdq}
 				</if><if test="xmklx !='' and xmklx != null ">
 			and xmklx like '%'||(#{xmklx})||'%'
 		</if>) t where 
			sck_sbthcd &lt;=#{sck_sbthcd}
		<if test="gydw!='' and gydw!= null ">
			${gydw}
		</if>
		<if test="xzqhdm!='' and xzqhdm!= null ">
			${xzqhdm}
		</if>
		<if test="lxmc!='' and lxmc!= null ">
			and lxmc like '%'||(#{lxmc})||'%'
		</if>
		<if test="qlmc!='' and qlmc!= null ">
			and qlmc like '%'||(#{qlmc})||'%'
		</if>
		<if test="xmnf!='' and xmnf!= null ">
			and scxmnf in (${xmnf})
		</if>
		<if test="xmtype!='' and xmtype!= null ">
			and xmtype like '%'||(#{xmtype})||'%'
		</if>
		<if test="sbzt!='' and sbzt!= null ">
			and decode(sck_sbthcd,#{sck_sbthcd},'未上报',sck_sbzt) like '%'||(#{sbzt})||'%'
		</if>
		 <if test="jsdj!='' and jsdj!= null ">
			${jsdj}
		</if> 
		 <if test="gldj!='' and gldj!= null ">
			${gldj}
		</if> 
		<if test="akjfl!='' and akjfl!= null ">
			${akjfl}
		</if>
		<if test="bzls!='' and bzls!= null ">
 			and bzls like #{bzls}||'%'
 		</if>
 		<if test="lxbm!='' and lxbm!= null ">
			and lxbm like '%'||(#{lxbm})||'%'
		</if>
		<if test="qlbh!='' and qlbh!= null ">
			and qlbh like '%'||(#{qlbh})||'%'
		</if>
	</select>

	<update id="updateSckwqgz" parameterType="sckwqgz">
		update sck_wqgz set
		tzgs=#{tzgs},spwh=#{spwh},fapgdw=#{fapgdw},fascdw=#{fascdw},faspsj=#{faspsj},
		jsxz=#{jsxz},jsnr=#{jsnr},scbz=#{scbz},scxmnf=#{scxmnf},scqlqc=#{scqlqc},scqlqk=#{scqlqk}
		where sckid=#{sckid} 
	</update>
	<select id="selectSckwqgzById" parameterType="sckwqgz"
		resultType="sckwqgz">
		select * from sck_wqgz t join xmk_wqgz on xmkid=xmk_wqgz.id where
		sckid=#{sckid}
	</select>
	<delete id="deleteSckWqgz" parameterType="java.util.List">
		delete from sck_wqgz where sckid =#{String}
	</delete>

	<update id="xgSckWqgzSbzt" parameterType="hashmap">
		update sck_wqgz set sck_sbzt='已上报', sck_sbsj=sysdate,sck_sbbm=#{sck_sbbm},
 		sck_sbthcd=#{sck_sbthcd} where sckid =#{sckid}
	</update>
	
	<update id="xgSckWqgzShzt" parameterType="hashmap">
		update sck_wqgz set sck_shzt='已审核',lrjh='已列入',sck_shsj=sysdate,sck_shbm=#{sck_shbm} where sckid=#{sckid}
	</update>

	<update id="xgSckWqgzTH" parameterType="java.util.List">
		update sck_wqgz set sck_sbthcd=(sck_sbthcd+2) where sckid =#{String}
	</update>

	<select id="selectSckShwqgz" parameterType="sckwqgz" resultType="sckwqgz">
		select * from (
		select rownum num ,t.* from (select * from sck_wqgz t join xmk_wqgz on
		xmkid=xmk_wqgz.id 
		where 1=1 and t.SFYLRBWQK='是'
		<if test="tsdq!='' and tsdq!= null ">
		${tsdq}
		</if>
		<if test="xmklx !='' and xmklx != null ">
		and xmklx like '%'||(#{xmklx})||'%'
 		</if>	
 				) t
		where sck_sbthcd=7
			and sck_sbthcd>=#{sck_sbthcd}
		<if test="gydw!='' and gydw!= null ">
			${gydw}
		</if>
		<if test="xzqhdm!='' and xzqhdm!= null ">
			${xzqhdm}
		</if>
		<if test="lxmc!='' and lxmc!= null ">
			and lxmc like '%'||(#{lxmc})||'%'
		</if>
		<if test="qlmc!='' and qlmc!= null ">
			and qlmc like '%'||(#{qlmc})||'%'
		</if>
		<if test="xmnf!='' and xmnf!= null ">
			and scxmnf in (${xmnf})
		</if>
		<if test="xmtype!='' and xmtype!= null ">
			and xmtype like '%'||(#{xmtype})||'%'
		</if>
		<if test="shzt!='' and shzt!= null ">
			<if test="shzt == '已审核'">
			and sck_shzt like '%'||(#{shzt})||'%'
			</if>
			<if test="shzt == '未审核'">
			and (sck_shzt like '%'||(#{shzt})||'%' or sck_shzt is null or sck_shzt='')
			</if>
		</if>
		 <if test="jsdj!='' and jsdj!= null ">
			${jsdj}
		</if> 
		<if test="gldj!='' and gldj!= null ">
			${gldj}
		</if> 
		<if test="akjfl!='' and akjfl!= null ">
			${akjfl}
		</if>
		<if test="bzls!='' and bzls!= null ">
 			and bzls like #{bzls}||'%'
 		</if>
 		<if test="lxbm!='' and lxbm!= null ">
			and lxbm like '%'||(#{lxbm})||'%'
		</if>
		<if test="qlbh!='' and qlbh!= null ">
			and qlbh like '%'||(#{qlbh})||'%'
		</if>
		
		) t1 where t1.num &lt;=(#{page} * #{rows}) and
		t1.num>(#{page}-1)*#{rows}
		order by sck_shzt desc,lrjh desc
	</select>
	<select id="selectSckWqgzShCount" parameterType="sckwqgz"
		resultType="int">
		select count(*) from (select * from sck_wqgz t join xmk_wqgz on
		xmkid=xmk_wqgz.id
		where 1=1 and t.SFYLRBWQK='是'
		<if test="tsdq!='' and tsdq!= null ">
		${tsdq}
		</if>
		<if test="xmklx !='' and xmklx != null ">
		and xmklx like '%'||(#{xmklx})||'%'
 		</if>
 		) t
		where sck_sbthcd=7
			and sck_sbthcd>=#{sck_sbthcd}
		<if test="gydw!='' and gydw!= null ">
			${gydw}
		</if>
		<if test="xzqhdm!='' and xzqhdm!= null ">
			${xzqhdm}
		</if>
		<if test="lxmc!='' and lxmc!= null ">
			and lxmc like '%'||(#{lxmc})||'%'
		</if>
		<if test="qlmc!='' and qlmc!= null ">
			and qlmc like '%'||(#{qlmc})||'%'
		</if>
		<if test="xmnf!='' and xmnf!= null ">
			and scxmnf in (${xmnf})
		</if>
		<if test="xmtype!='' and xmtype!= null ">
			and xmtype like '%'||(#{xmtype})||'%'
		</if>
		<if test="shzt!='' and shzt!= null ">
			<if test="shzt == '已审核'">
			and sck_shzt like '%'||(#{shzt})||'%'
			</if>
			<if test="shzt == '未审核'">
			and (sck_shzt like '%'||(#{shzt})||'%' or sck_shzt is null or sck_shzt='')
			</if>
		</if>
		 <if test="jsdj!='' and jsdj!= null ">
			${jsdj}
		</if> 
		<if test="gldj!='' and gldj!= null ">
			${gldj}
		</if> 
		<if test="akjfl!='' and akjfl!= null ">
			${akjfl}
		</if>
		<if test="bzls!='' and bzls!= null ">
 			and bzls like #{bzls}||'%'
 		</if>
 		<if test="lxbm!='' and lxbm!= null ">
			and lxbm like '%'||(#{lxbm})||'%'
		</if>
		<if test="qlbh!='' and qlbh!= null ">
			and qlbh like '%'||(#{qlbh})||'%'
		</if>
	</select>
	<select id="onceSckWqgz" parameterType="sckwqgz" resultType="int">
 		select count(*) from sck_wqgz where lrjh='未列入'
 		<if test="qlbh!='' and qlbh!= null "  >
 			and (sck_qlbh=#{qlbh}
 			or (sck_lxbm=#{lxbm} and to_number(sck_qlzxzh)=to_number(#{qlzxzh})))
 		</if>
 		<if test="scxmnf!='' and scxmnf!=  null "  >
 			and scxmnf=#{scxmnf}
 		</if>
 		
 	</select>
	<select id="bzWqgz" parameterType="sckwqgz" resultType="int">
 		SELECT C1.CON1+C2.CON2 FROM
		(select count(*) CON1 from sck_wqgz where lrjh='已列入' 
		and (sck_qlbh=#{qlbh}
		or (sck_lxbm=#{lxbm} and to_number(sck_qlzxzh)=to_number(#{qlzxzh})))
		)C1,
		(select count(*) CON2 from sck_wqgz SC,
		(select YQLBH,YLXBM,YQLZXZH from XTGL_QLSJ where (xqlbh=#{qlbh}
		or (xlxbm=#{lxbm} and xqlzxzh=to_number(#{qlzxzh})))) k
		where SC.lrjh='已列入' AND (SC.sck_qlbh=k.YQLBH
		or (SC.sck_lxbm=k.YLXBM and to_number(SC.sck_qlzxzh)=to_number(k.YQLZXZH)))
		)C2
 	</select>

   <select id="daoRuwqgzsh" parameterType="sckwqgz" resultType="sckwqgz">
 		select * from xmk_wqgz where shzt='已审核'
 		<if test="gydwbm!='' and gydwbm!= null ">
			and gydw in(select name from xtgl_department where id like #{gydwbm}||'%' or parent like #{gydwbm}||'%') 
		</if>
 		<if test="qlbh!='' and qlbh!= null "  >
 			and (qlbh=#{qlbh}
 			or (lxbm=#{lxbm} and to_number(qlzxzh)=#{qlzxzh}))
 		</if>
 </select>
 
	
	<select id="exportExcel_wqgz_scgl" parameterType="sckwqgz"
		resultType="sjbb">
		select
		shzt v_0,gydw v_1,xzqhmc v_2,qlbh v_3,qlmc v_4,qlzxzh v_5,lxbm v_6,lxmc
		v_7,pddj v_8,xjgjnd v_9,xmnf v_10,jsxz v_11
		from sck_wqgz t join xmk_wqgz on xmkid=xmk_wqgz.id where 1=1
		and sck_sbthcd &lt;=#{sck_sbthcd}
		<if test="gydw!='' and gydw!= null ">
			${gydw}
		</if>
		<if test="xzqhdm!='' and xzqhdm!= null ">
			${xzqhdm}
		</if>
		<if test="lxmc!='' and lxmc!= null ">
			and lxmc like '%'||(#{lxmc})||'%'
		</if>
		<if test="qlmc!='' and qlmc!= null ">
			and qlmc like '%'||(#{qlmc})||'%'
		</if>
		<if test="xmnf!='' and xmnf!= null ">
			${xmnf}
		</if>
		<if test="xmtype!='' and xmtype!= null ">
			and xmtype like '%'||(#{xmtype})||'%'
		</if>
		<if test="sbzt!='' and sbzt!= null ">
			and decode(sck_sbthcd,#{sck_sbthcd},'未上报',sck_sbzt) like '%'||(#{sbzt})||'%'
		</if>
		<!-- <if test="jsdj!='' and jsdj!= null ">
			and jsdj like '%'||(#{jsdj})||'%'
		</if> -->
		<if test="akjfl!='' and akjfl!= null ">
			${akjfl}
		</if>
		<if test="bzls!='' and bzls!= null ">
 			and bzls like #{bzls}||'%'
 		</if>
 		<if test="lxbm!='' and lxbm!= null ">
			and lxbm like '%'||(#{lxbm})||'%'
		</if>
		<if test="qlbh!='' and qlbh!= null ">
			and qlbh like '%'||(#{qlbh})||'%'
		</if>
		<if test="tsdq!='' and tsdq!= null">
			${tsdq}
		</if>
		<if test="jsdj!='' and jsdj!= null">
			${jsdj}
		</if>
		 <if test="gldj!='' and gldj!= null ">
			${gldj}
		</if> 
	</select>
	<select id="exportExcel_wqgz_scsh" parameterType="sckwqgz"
		resultType="sjbb">
		select
		shzt v_0,gydw v_1,xzqhmc v_2,qlbh v_3,qlmc v_4,qlzxzh v_5,lxbm v_6,lxmc
		v_7,pddj v_8,xjgjnd v_9,xmnf v_10,jsxz v_11
		from sck_wqgz t join xmk_wqgz on xmkid=xmk_wqgz.id where 1=1 and
			sck_sbthcd=7
			and sck_sbthcd>=#{sck_sbthcd}
		<if test="gydw!='' and gydw!= null ">
			${gydw}
		</if>
		<if test="xzqhdm!='' and xzqhdm!= null ">
			${xzqhdm}
		</if>
		<if test="lxmc!='' and lxmc!= null ">
			and lxmc like '%'||(#{lxmc})||'%'
		</if>
		<if test="qlmc!='' and qlmc!= null ">
			and qlmc like '%'||(#{qlmc})||'%'
		</if>
		<if test="xmnf!='' and xmnf!= null ">
			and scxmnf like '%'||(#{xmnf})||'%'
		</if>
		<if test="xmtype!='' and xmtype!= null ">
			and xmtype like '%'||(#{xmtype})||'%'
		</if>
		<if test="shzt!='' and shzt!= null ">
			<if test="shzt == '已审核'">
			and sck_shzt like '%'||(#{shzt})||'%'
			</if>
			<if test="shzt == '未审核'">
			and (sck_shzt like '%'||(#{shzt})||'%' or sck_shzt is null or sck_shzt='')
			</if>
		</if>
		<!-- <if test="jsdj!='' and jsdj!= null ">
			and jsdj like '%'||(#{jsdj})||'%'
		</if> -->
		<if test="akjfl!='' and akjfl!= null ">
			${akjfl}
		</if>
		<if test="bzls!='' and bzls!= null ">
 			and bzls like #{bzls}||'%'
 		</if>
 		<if test="lxbm!='' and lxbm!= null ">
			and lxbm like '%'||(#{lxbm})||'%'
		</if>
		<if test="qlbh!='' and qlbh!= null ">
			and qlbh like '%'||(#{qlbh})||'%'
		</if>
		<if test="tsdq!='' and tsdq!= null ">
		${tsdq}
		</if>
		<if test="xmklx !='' and xmklx != null ">
		and xmklx like '%'||(#{xmklx})||'%'
 		</if>	
 		 <if test="jsdj!='' and jsdj!= null ">
			${jsdj}
		</if> 
		<if test="gldj!='' and gldj!= null ">
			${gldj}
		</if> 
	</select>
	<select id="insertToSheet" resultType="sjbb" parameterType="hashMap">
		select
		qlbh v_0,qlmc v_1,qlzxzh v_2,lxbm v_3,qlqc v_4,qlkd v_5
		from xmk_wqgz where shzt='已审核'
		and id not in (select xmkid from sck_wqgz)
		<if test="tbdw!=null and tbdw!=''">
		and tbbmbm like #{tbdw}||'%'
	</if>
	</select>
	<insert id="importWqgz_sc" parameterType="hashMap">
		insert into
		sck_wqgz(sckid,xmkid,fapgdw,fascdw,faspsj,spwh,tzgs,jsxz,jsnr,scbz,sck_sbzt,sck_shzt,sck_qlbh,sck_qlzxzh,sck_lxbm,scbmbm,sck_sbthcd,lrjh,bzls)
		values(sys_guid(),(select ID from XMK_WQGZ where qlbh=trim(#{0}) and
		qlmc=trim(#{1})),#{6},#{7},#{8},#{9},#{10},#{11},#{12},#{13},'未上报','未审核',#{0},#{2},#{3},#{scbmbm},#{sck_sbthcd},'未列入','无')
	</insert>
	<!--  列入计划-->
 
 <select id="lrjhWqgz" parameterType="sckwqgz" resultType="sckwqgz">
 	select * from (
 		select rownum num ,t.* from (select * from sck_wqgz t join xmk_wqgz on xmkid=xmk_wqgz.id where 1=1
 				<if test="tsdq!='' and tsdq!= null ">
 				and xmk_wqgz.tsdq like '%'||#{tsdq}||'%'
 				</if>) t 
 		where sck_shzt='已审核' and lrjh='未列入'
			and sck_sbthcd>=#{sck_sbthcd}
			<if test="gydw!='' and gydw!= null ">
			${gydw}
		</if>
		<if test="xzqhdm!='' and xzqhdm!= null ">
			${xzqhdm}
		</if>
		<if test="qlmc!='' and qlmc!= null ">
			and qlmc like '%'||(#{qlmc})||'%'
		</if>
		<if test="xmnf!='' and xmnf!= null ">
			and scxmnf like '%'||(#{xmnf})||'%'
		</if>
		<!-- <if test="jsdj!='' and jsdj!= null ">
			and jsdj like '%'||(#{jsdj})||'%'
		</if> -->
		<if test="akjfl!='' and akjfl!= null ">
			and akjfl like #{akjfl}||'%'
		</if>
		<if test="bzls!='' and bzls!= null ">
 			and bzls like #{bzls}||'%'
 		</if>
		<if test="qlbh!='' and qlbh!= null ">
			and qlbh like '%'||(#{qlbh})||'%'
		</if>
 			) t1 where t1.num &lt;=(#{page} * #{rows}) and t1.num>(#{page}-1)*#{rows} 
 			order by sck_shzt desc,lrjh desc
 </select>
  <select id="lrjhWqgzCount" parameterType="sckwqgz" resultType="int">
 		select count(*) from (select * from sck_wqgz t join xmk_wqgz on xmkid=xmk_wqgz.id where 1=1
 				<if test="tsdq!='' and tsdq!= null ">
 				and xmk_wqgz.tsdq like '%'||#{tsdq}||'%'
 				</if>)
 		 where sck_shzt='已审核' and lrjh='未列入'
			and sck_sbthcd>=#{sck_sbthcd}
			<if test="gydw!='' and gydw!= null ">
			${gydw}
		</if>
		<if test="xzqhdm!='' and xzqhdm!= null ">
			${xzqhdm}
		</if>
			<if test="qlmc!='' and qlmc!= null ">
			and qlmc like '%'||(#{qlmc})||'%'
		</if>
		<if test="xmnf!='' and xmnf!= null ">
			and scxmnf like '%'||(#{xmnf})||'%'
		</if>
		<!-- <if test="jsdj!='' and jsdj!= null ">
			and jsdj like '%'||(#{jsdj})||'%'
		</if> -->
		<if test="akjfl!='' and akjfl!= null ">
			and akjfl like #{akjfl}||'%'
		</if>
		<if test="bzls!='' and bzls!= null ">
 			and bzls like #{bzls}||'%'
 		</if>
		<if test="qlbh!='' and qlbh!= null ">
			and qlbh like '%'||(#{qlbh})||'%'
		</if>
 </select>
 <update id="xgWqgzXmnf" parameterType="sckwqgz" >
 		update xmk_wqgz set xmnf=#{xmnf} where id=#{xmkid}
 </update>
</mapper>
